FROM ghcr.io/osgeo/gdal:ubuntu-full-3.7.1

LABEL maintainer="Youssef Harby <me@youssefharby.com>"

ENV DUCKDB_VERSION=0.8.1 \
    PLATFORM_ARCH=amd64

# DuckDB extension settings # https://duckdb.org/docs/archive/0.8.1/extensions/overview#downloading-extensions-directly-from-s3
ENV RELEASE_VERSION_NUMBER=0.8.1
ENV PLATFORM_NAME=linux_arm64
ENV EXTENSION_NAME=httpfs

# linux_amd64_gcc4 / linux_amd64 / linux_arm64 / osx_amd64 / osx_arm64 / windows_amd64 / windows_amd64_rtools


# Install dependencies
RUN apt-get update && \
    apt-get install -y software-properties-common && \
    add-apt-repository ppa:deadsnakes/ppa && \
    apt-get update && \
    apt-get install -y build-essential python3.10 python3-pip python3.10-venv && \
    apt-get install -y clang unixodbc  && \
    python3.10 -m pip install --upgrade pip

# Install duckdb cli
RUN wget https://github.com/duckdb/duckdb/releases/download/v${DUCKDB_VERSION}/duckdb_cli-linux-${PLATFORM_ARCH}.zip \
    && unzip duckdb_cli-linux-${PLATFORM_ARCH}.zip -d /usr/local/bin \
    && rm duckdb_cli-linux-${PLATFORM_ARCH}.zip

# Download and install DuckDB extension
RUN mkdir -p /root/.duckdb/extensions/v${RELEASE_VERSION_NUMBER}/${PLATFORM_NAME} && \
    wget -O /tmp/${EXTENSION_NAME}.duckdb_extension.gz https://extensions.duckdb.org/v${RELEASE_VERSION_NUMBER}/${PLATFORM_NAME}/${EXTENSION_NAME}.duckdb_extension.gz && \
    gunzip /tmp/${EXTENSION_NAME}.duckdb_extension.gz && \
    mv /tmp/${EXTENSION_NAME}.duckdb_extension /root/.duckdb/extensions/v${RELEASE_VERSION_NUMBER}/${PLATFORM_NAME}/${EXTENSION_NAME}.duckdb_extension

RUN pip install poetry==1.4.2

ENV POETRY_NO_INTERACTION=1 \
    POETRY_VIRTUALENVS_IN_PROJECT=1 \
    POETRY_VIRTUALENVS_CREATE=1 \
    POETRY_CACHE_DIR=/tmp/poetry_cache
# POETRY_VIRTUALENVS_PATH=/app/.venv

WORKDIR /app

ENV GLIBCXX_USE_CXX11_ABI=0 
COPY pyproject.toml poetry.lock ./

RUN --mount=type=cache,target=$POETRY_CACHE_DIR poetry install --without dev --no-root

ENV PATH="/app/.venv/bin:$PATH"

COPY overturemapsdownloader ./overturemapsdownloader